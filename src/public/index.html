<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cursor To OpenAI - API Key 管理</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
        }
        h1, h2 {
            color: #2c3e50;
        }
        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .card {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, textarea, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        input[type="checkbox"] {
            width: auto;
            margin-right: 5px;
        }
        input[type="number"] {
            width: 100px;
        }
        .checkbox-container {
            display: flex;
            align-items: center;
        }
        .checkbox-label {
            display: inline;
            margin-left: 5px;
        }
        textarea {
            min-height: 100px;
            font-family: monospace;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #2980b9;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f2f2f2;
        }
        .action-btn {
            background: #e74c3c;
            margin-right: 5px;
        }
        .action-btn:hover {
            background: #c0392b;
        }
        .edit-btn {
            background: #f39c12;
            margin-right: 5px;
        }
        .edit-btn:hover {
            background: #d35400;
        }
        .refresh-btn {
            background: #27ae60;
            margin-right: 5px;
        }
        .refresh-btn:hover {
            background: #219653;
        }
        .info {
            background-color: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            border-radius: 8px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
        }
        /* 无效Cookie样式 */
        .cookie-text {
            max-width: 80%;
            word-break: break-all;
        }
        .cookie-warning {
            color: #ffa500;
        }
        .cookie-warning-text {
            font-size: 0.8em;
            font-weight: normal;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>Cursor To OpenAI - API Key 管理</h1>
            <p>在此页面上，您可以管理自定义 API Key 与 Cursor Cookie 的映射关系。</p>
            <div style="margin-top: 10px; display: flex; justify-content: space-between; align-items: center;">
                <div>
                <button id="testApiBtn" style="margin-right: 10px;">测试API连接</button>
                <button id="clearCacheBtn">清除缓存并刷新</button>
                </div>
                <div>
                    <span id="adminUsername" style="margin-right: 10px;"></span>
                    <button id="logoutBtn" style="background: #e74c3c;">退出登录</button>
                </div>
            </div>
            <div id="testApiResult" style="margin-top: 10px;"></div>
        </div>

        <div class="card">
            <h2>添加/更新 API Key</h2>
            <div id="addKeyMessage"></div>
            <form id="addKeyForm">
                <div class="form-group">
                    <label for="apiKey">API Key（自定义）</label>
                    <input type="text" id="apiKey" name="apiKey" placeholder="输入您想使用的自定义 API Key" required>
                </div>
                <div class="form-group">
                    <label for="cookieValues">Cursor Cookie 值（多个值请用逗号分隔）</label>
                    <textarea id="cookieValues" name="cookieValues" placeholder="输入 WorkosCursorSessionToken 值，多个值请用逗号分隔" required></textarea>
                </div>
                <button type="submit">保存</button>
            </form>
        </div>

        <div class="card">
            <h2>现有 API Key</h2>
            <div id="keyListMessage"></div>
            <div class="info">
                <p><strong>注意：</strong>系统将自动检测并处理cookie数量为0的API Key。当检测到API Key没有可用cookie时，系统会尝试自动获取新cookie。</p>
                <p>您也可以手动点击下方的"刷新Cookie"按钮主动获取。</p>
            </div>
            <table id="keyTable">
                <thead>
                    <tr>
                        <th>API Key</th>
                        <th>Cookie 数量</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="keyList">
                    <!-- 数据将通过 JavaScript 动态加载 -->
                </tbody>
            </table>
        </div>

        <div class="card">
            <h2>使用说明</h2>
            <ol>
                <li>添加自定义 API Key 和对应的 Cursor Cookie 值。</li>
                <li>使用自定义 API Key 作为 OpenAI API 的认证凭证。</li>
                <li>系统将自动在多个 Cookie 之间进行轮询。</li>
                <li>API 端点：
                    <ul>
                        <li>模型列表：<code>/v1/models</code></li>
                        <li>聊天补全：<code>/v1/chat/completions</code></li>
                    </ul>
                </li>
            </ol>
        </div>
    </div>

    <!-- 修改 Cookie 的模态框 -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>修改 API Key 的 Cookie</h2>
            <div id="editModalMessage"></div>
            <form id="editCookieForm">
                <input type="hidden" id="editApiKey" name="editApiKey">
                <div class="form-group">
                    <label for="editCookieValues">Cursor Cookie 值（多个值请用逗号分隔）</label>
                    <textarea id="editCookieValues" name="editCookieValues" placeholder="输入 WorkosCursorSessionToken 值，多个值请用逗号分隔" required></textarea>
                </div>
                <button type="submit">保存修改</button>
            </form>
        </div>
    </div>

    <div class="card">
        <h2>无效Cookie管理</h2>
        <div class="form-group">
            <div class="info">
                以下是系统自动检测到的无效Cookie列表。这些Cookie在请求过程中被发现无效，已被自动从API Key中移除。
            </div>
            <div id="invalidCookiesContainer">
                <div style="text-align: center; padding: 20px;">
                    <div>加载中...</div>
                </div>
            </div>
            <button id="clearAllInvalidCookies" style="background: #e74c3c;">清除所有无效Cookie</button>
        </div>
    </div>

    <!-- 新增：Cookie刷新功能 -->
    <div class="card">
        <h2>Cookie自动刷新</h2>
        <div class="form-group">
            <div class="info">
                <p>系统支持自动刷新Cookie，确保API Key始终有足够的可用Cookie。您可以在此手动触发刷新操作。</p>
                <p><strong>自动获取说明：</strong></p>
                <ul>
                    <li>当检测到API Key没有可用cookie时，系统会在请求时自动尝试获取</li>
                    <li>自动获取过程需要几分钟时间，期间请求可能会失败</li>
                    <li>获取成功后，后续请求将自动使用新cookie</li>
                    <li>如需立即使用，您可以手动点击下方的"刷新Cookie"按钮</li>
                </ul>
            </div>
            <div id="refreshCookieMessage"></div>
            <div style="margin-top: 15px;">
                <div class="form-group">
                    <label for="refreshApiKey">选择要刷新的API Key（不选则刷新所有）</label>
                    <select id="refreshApiKey">
                        <option value="">所有API Key</option>
                    </select>
                </div>
                <button id="refreshCookieBtn">刷新Cookie</button>
            </div>
            <div id="refreshStatusContainer" style="display: none; margin-top: 15px;">
                <div style="margin-bottom: 10px;" id="refreshStatus">处理中...</div>
                <progress id="refreshProgress" value="0" max="100" style="width: 100%;"></progress>
            </div>
        </div>
    </div>

    <!-- 新增：Cookie自动获取配置 -->
    <div class="card">
        <h2>Cookie自动获取设置</h2>
        <div class="form-group">
            <div class="info">
                <p>您可以在此设置Cookie自动获取的阈值。当API Key的cookie数量低于该阈值时，系统会自动尝试获取新cookie。</p>
                <p><strong>自动获取行为说明：</strong></p>
                <ul>
                    <li>当cookie数量<strong>低于阈值但大于0</strong>时：系统会在<strong>后台异步获取</strong>新cookie，不影响当前请求的处理</li>
                    <li>当cookie数量<strong>等于0</strong>时：系统必须等待同步获取新cookie，可能导致请求延迟</li>
                    <li>建议将阈值设置为2或更高，以保证系统有足够的缓冲来处理请求</li>
                </ul>
            </div>
            <div id="autoFetchConfigMessage"></div>
            <form id="autoFetchConfigForm">
                <div class="form-group checkbox-container">
                    <input type="checkbox" id="autoFetchEnabled" checked>
                    <label for="autoFetchEnabled" class="checkbox-label">启用自动获取</label>
                </div>
                <div class="form-group">
                    <label for="autoFetchThreshold">自动获取阈值</label>
                    <div style="display: flex; align-items: center;">
                        <input type="number" id="autoFetchThreshold" min="0" max="10" value="2" style="width: 80px;">
                        <span style="margin-left: 10px;">当API Key的cookie数量低于此值时，系统会自动获取新cookie</span>
                    </div>
                </div>
                <button type="submit">保存设置</button>
            </form>
        </div>
    </div>

    <!-- 新增：Cookie轮换策略配置 -->
    <div class="card">
        <h2>Cookie轮换策略设置</h2>
        <div class="form-group">
            <div class="info">
                <p>您可以在此设置系统使用Cookie的策略。不同策略会影响系统如何选择使用API Key的Cookie。</p>
                <p><strong>可用策略说明：</strong></p>
                <ul>
                    <li><strong>轮询策略 (round-robin)</strong>：按顺序循环使用Cookie，确保每个Cookie都被均匀使用</li>
                    <li><strong>随机策略 (random)</strong>：随机选择一个Cookie使用，可能导致某些Cookie使用频率较高</li>
                    <li><strong>健康优先 (health-first)</strong>：优先使用历史表现更好的Cookie，系统会自动记录并学习每个Cookie的成功率</li>
                </ul>
                <p><strong>建议：</strong>健康优先策略可以自动避开问题Cookie，提高请求成功率</p>
            </div>
            <div id="rotationStrategyMessage"></div>
            <form id="rotationStrategyForm">
                <div class="form-group">
                    <label for="rotationStrategy">选择Cookie轮换策略</label>
                    <select id="rotationStrategy" style="width: 200px;">
                        <option value="health-first">健康优先 (health-first)</option>
                        <option value="round-robin">轮询策略 (round-robin)</option>
                        <option value="random">随机策略 (random)</option>
                    </select>
                </div>
                <button type="submit">保存策略</button>
            </form>
        </div>
    </div>

    <script>
        // 获取模态框元素
        const modal = document.getElementById('editModal');
        const closeBtn = document.getElementsByClassName('close')[0];
        
        // 关闭模态框
        closeBtn.onclick = function() {
            modal.style.display = 'none';
        }
        
        // 点击模态框外部关闭
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }
        
        // 加载现有 API Key
        async function loadApiKeys() {
            try {
                console.log('开始加载API Keys...');
                const response = await fetch('/v1/api-keys', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP错误: ${response.status} ${response.statusText}`);
                }
                
                console.log('API响应状态:', response.status);
                const data = await response.json();
                console.log('获取到的数据:', data);
                
                if (data.success) {
                    renderApiKeyList(data.apiKeys);
                } else {
                    document.getElementById('keyList').innerHTML = '<tr><td colspan="3">加载失败</td></tr>';
                }
            } catch (error) {
                console.error('加载 API Key 失败:', error);
                document.getElementById('keyListMessage').innerHTML = `
                    <div class="error">加载 API Key 失败: ${error.message}</div>
                `;
            }
        }

        // 添加/更新 API Key
        document.getElementById('addKeyForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const apiKey = document.getElementById('apiKey').value.trim();
            const cookieValuesText = document.getElementById('cookieValues').value.trim();
            
            if (!apiKey || !cookieValuesText) {
                document.getElementById('addKeyMessage').innerHTML = `
                    <div class="error">API Key 和 Cookie 值不能为空</div>
                `;
                return;
            }
            
            // 将逗号分隔的 Cookie 值转换为数组
            const cookieValues = cookieValuesText.split(',').map(cookie => cookie.trim()).filter(cookie => cookie);
            
            try {
                const response = await fetch('/v1/api-keys', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        apiKey,
                        cookieValues,
                    }),
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('addKeyMessage').innerHTML = `
                        <div class="info">API Key 添加/更新成功</div>
                    `;
                    document.getElementById('apiKey').value = '';
                    document.getElementById('cookieValues').value = '';
                    loadApiKeys();
                } else {
                    document.getElementById('addKeyMessage').innerHTML = `
                        <div class="error">API Key 添加/更新失败: ${data.error}</div>
                    `;
                }
            } catch (error) {
                console.error('添加/更新 API Key 失败:', error);
                document.getElementById('addKeyMessage').innerHTML = `
                    <div class="error">添加/更新 API Key 失败: ${error.message}</div>
                `;
            }
        });

        // 删除 API Key
        async function deleteApiKey(apiKey) {
            if (!confirm(`确定要删除 API Key "${apiKey}" 吗？`)) {
                return;
            }
            
            try {
                const response = await fetch(`/v1/api-keys/${encodeURIComponent(apiKey)}`, {
                    method: 'DELETE',
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('keyListMessage').innerHTML = `
                        <div class="info">API Key 删除成功</div>
                    `;
                    loadApiKeys();
                } else {
                    document.getElementById('keyListMessage').innerHTML = `
                        <div class="error">API Key 删除失败: ${data.error}</div>
                    `;
                }
            } catch (error) {
                console.error('删除 API Key 失败:', error);
                document.getElementById('keyListMessage').innerHTML = `
                    <div class="error">删除 API Key 失败: ${error.message}</div>
                `;
            }
        }
        
        // 获取API Key的Cookie值
        async function getCookiesForApiKey(apiKey) {
            try {
                const response = await fetch(`/v1/api-keys/${encodeURIComponent(apiKey)}/cookies`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP错误: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                return data.cookies;
            } catch (error) {
                console.error(`获取 ${apiKey} 的Cookie值失败:`, error);
                throw error;
            }
        }
        
        // 修改 API Key
        async function editApiKey(apiKey) {
            try {
                document.getElementById('editModalMessage').innerHTML = '';
                document.getElementById('editApiKey').value = apiKey;
                
                // 获取当前Cookie值
                const cookies = await getCookiesForApiKey(apiKey);
                document.getElementById('editCookieValues').value = cookies.join(',');
                
                // 显示模态框
                modal.style.display = 'block';
            } catch (error) {
                alert(`获取 ${apiKey} 的Cookie值失败: ${error.message}`);
            }
        }
        
        // 提交修改表单
        document.getElementById('editCookieForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const apiKey = document.getElementById('editApiKey').value.trim();
            const cookieValuesText = document.getElementById('editCookieValues').value.trim();
            
            if (!apiKey || !cookieValuesText) {
                document.getElementById('editModalMessage').innerHTML = `
                    <div class="error">API Key 和 Cookie 值不能为空</div>
                `;
                return;
            }
            
            // 将逗号分隔的 Cookie 值转换为数组
            const cookieValues = cookieValuesText.split(',').map(cookie => cookie.trim()).filter(cookie => cookie);
            
            try {
                const response = await fetch('/v1/api-keys', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        apiKey,
                        cookieValues,
                    }),
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('editModalMessage').innerHTML = `
                        <div class="info">Cookie 修改成功</div>
                    `;
                    setTimeout(() => {
                        modal.style.display = 'none';
                        loadApiKeys();
                    }, 1500);
                } else {
                    document.getElementById('editModalMessage').innerHTML = `
                        <div class="error">Cookie 修改失败: ${data.error}</div>
                    `;
                }
            } catch (error) {
                console.error('修改 Cookie 失败:', error);
                document.getElementById('editModalMessage').innerHTML = `
                    <div class="error">修改 Cookie 失败: ${error.message}</div>
                `;
            }
        });

        // 测试API连接
        document.getElementById('testApiBtn').addEventListener('click', async function() {
            const resultDiv = document.getElementById('testApiResult');
            resultDiv.innerHTML = '<div class="info">正在测试API连接...</div>';
            
            try {
                const response = await fetch('/v1/api-keys', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });
                
                resultDiv.innerHTML = `<div class="info">API响应状态: ${response.status}</div>`;
                
                if (!response.ok) {
                    throw new Error(`HTTP错误: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                resultDiv.innerHTML += `<div class="info">获取到的数据: ${JSON.stringify(data)}</div>`;
            } catch (error) {
                console.error('测试API失败:', error);
                resultDiv.innerHTML = `<div class="error">测试API失败: ${error.message}</div>`;
            }
        });
        
        // 清除缓存并刷新
        document.getElementById('clearCacheBtn').addEventListener('click', function() {
            // 清除缓存
            if ('caches' in window) {
                caches.keys().then(function(names) {
                    for (let name of names) {
                        caches.delete(name);
                    }
                });
            }
            
            // 强制刷新页面（绕过缓存）
            window.location.reload(true);
        });

        // 添加刷新API Key列表的函数，实时获取最新状态
        async function refreshApiKeyList() {
            try {
                // 强制从服务器获取最新数据
                const response = await fetch('/v1/api-keys', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-store, no-cache, must-revalidate, proxy-revalidate', 
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP错误: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                renderApiKeyList(data.apiKeys);
                populateRefreshApiKeySelect(); // 同时更新下拉选择框
                
                return data.apiKeys;
            } catch (error) {
                console.error('刷新API Key列表失败:', error);
                document.getElementById('keyListMessage').innerHTML = `
                    <div class="error">加载API Key失败: ${error.message}</div>
                `;
                throw error;
            }
        }

        // 渲染API Key列表
        function renderApiKeyList(apiKeys) {
            const keyList = document.getElementById('keyList');
            keyList.innerHTML = '';
            
            if (apiKeys && apiKeys.length > 0) {
                apiKeys.forEach(key => {
                    const row = document.createElement('tr');
                    
                    // 获取当前的自动获取阈值
                    const threshold = document.getElementById('autoFetchThreshold').value || 2;
                    
                    // 如果cookie数量小于阈值，添加警告样式和警告提示
                    const cookieCountClass = key.cookieCount < threshold ? 'class="cookie-warning"' : '';
                    const cookieCountWarning = key.cookieCount < threshold ? 
                        ` <span class="cookie-warning-text">(低于阈值${threshold}，系统将自动获取)</span>` : '';
                    
                    // 创建操作按钮
                    let actionsHTML = `
                        <button class="edit-btn" onclick="editApiKey('${key.key}')">修改</button>
                        <button class="action-btn" onclick="deleteApiKey('${key.key}')">删除</button>
                    `;
                    
                    // 如果cookie数量小于阈值，添加立即获取按钮
                    if (key.cookieCount < threshold) {
                        actionsHTML += `
                            <button class="refresh-btn" onclick="refreshSingleApiKey('${key.key}')">立即获取</button>
                        `;
                    }
                    
                    row.innerHTML = `
                        <td>${key.key}</td>
                        <td ${cookieCountClass}>${key.cookieCount}${cookieCountWarning}</td>
                        <td>${actionsHTML}</td>
                    `;
                    keyList.appendChild(row);
                });
            } else {
                keyList.innerHTML = '<tr><td colspan="3">暂无 API Key</td></tr>';
            }
        }

        // 获取无效Cookie列表
        async function getInvalidCookies() {
            try {
                const response = await fetch('/v1/invalid-cookies', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP错误: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                return data.invalidCookies;
            } catch (error) {
                console.error('获取无效Cookie失败:', error);
                throw error;
            }
        }
        
        // 清除特定无效Cookie
        async function clearInvalidCookie(cookie) {
            try {
                const response = await fetch(`/v1/invalid-cookies/${encodeURIComponent(cookie)}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP错误: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                return data.success;
            } catch (error) {
                console.error(`清除无效Cookie失败:`, error);
                throw error;
            }
        }
        
        // 清除所有无效Cookie
        async function clearAllInvalidCookies() {
            try {
                const response = await fetch('/v1/invalid-cookies', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP错误: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                return data.success;
            } catch (error) {
                console.error('清除所有无效Cookie失败:', error);
                throw error;
            }
        }
        
        // 渲染无效Cookie列表
        async function renderInvalidCookies() {
            const container = document.getElementById('invalidCookiesContainer');
            
            try {
                const invalidCookies = await getInvalidCookies();
                
                if (invalidCookies.length === 0) {
                    container.innerHTML = '<div class="info">没有检测到无效Cookie</div>';
                    return;
                }
                
                let html = '<table><thead><tr><th>无效Cookie</th><th>操作</th></tr></thead><tbody>';
                
                invalidCookies.forEach(cookie => {
                    // 截断显示cookie，避免页面过长
                    const displayCookie = cookie.length > 50 ? cookie.substring(0, 50) + '...' : cookie;
                    
                    html += `
                        <tr>
                            <td class="cookie-text" title="${cookie}">${displayCookie}</td>
                            <td>
                                <button class="action-btn clear-invalid-cookie" data-cookie="${cookie}">
                                    清除
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                container.innerHTML = html;
                
                // 添加清除按钮事件监听
                document.querySelectorAll('.clear-invalid-cookie').forEach(button => {
                    button.addEventListener('click', async function() {
                        const cookie = this.getAttribute('data-cookie');
                        
                        try {
                            await clearInvalidCookie(cookie);
                            showMessage('invalidCookiesContainer', '无效Cookie已清除', 'info');
                            renderInvalidCookies(); // 重新渲染列表
                        } catch (error) {
                            showMessage('invalidCookiesContainer', `清除失败: ${error.message}`, 'error');
                        }
                    });
                });
                
            } catch (error) {
                container.innerHTML = `<div class="error">加载失败: ${error.message}</div>`;
            }
        }
        
        // 清除所有无效Cookie按钮事件
        document.getElementById('clearAllInvalidCookies').addEventListener('click', async function() {
            try {
                await clearAllInvalidCookies();
                showMessage('invalidCookiesContainer', '所有无效Cookie已清除', 'info');
                renderInvalidCookies(); // 重新渲染列表
            } catch (error) {
                showMessage('invalidCookiesContainer', `清除失败: ${error.message}`, 'error');
            }
        });
        
        // 页面加载时获取 API Key 列表和无效Cookie列表
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            loadApiKeys();
            renderInvalidCookies();
            populateRefreshApiKeySelect();
            loadAutoFetchConfig(); // 加载自动获取配置
            loadRotationStrategy(); // 加载轮换策略配置
            
            // 添加定时刷新功能，每60秒刷新一次API Key列表和无效Cookie列表
            setInterval(() => {
                refreshApiKeyList();
                renderInvalidCookies();
            }, 60000);
        });

        // 显示消息的通用函数
        function showMessage(containerId, message, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="${type}">${message}</div>`;
        }

        // 填充刷新API Key的下拉选择框
        async function populateRefreshApiKeySelect() {
            try {
                const apiKeys = await getApiKeys();
                const select = document.getElementById('refreshApiKey');
                
                // 清空现有选项（保留"所有API Key"选项）
                while (select.options.length > 1) {
                    select.remove(1);
                }
                
                // 添加API Key选项
                apiKeys.forEach(key => {
                    const option = document.createElement('option');
                    option.value = key.key;
                    option.textContent = `${key.key} (${key.cookieCount} 个Cookie)`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('加载API Key选项失败:', error);
            }
        }

        // 获取API Keys的辅助函数
        async function getApiKeys() {
            const response = await fetch('/v1/api-keys', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Cache-Control': 'no-store, no-cache, must-revalidate, proxy-revalidate', 
                    'Pragma': 'no-cache',
                    'Expires': '0'
                }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP错误: ${response.status} ${response.statusText}`);
            }
            
            const data = await response.json();
            return data.success ? data.apiKeys : [];
        }

        // 为单个API Key刷新Cookie
        async function refreshSingleApiKey(apiKey) {
            try {
                if (!confirm(`确定要为API Key "${apiKey}" 获取新Cookie吗？此过程可能需要几分钟时间。`)) {
                    return;
                }
                
                document.getElementById('keyListMessage').innerHTML = `
                    <div class="info">正在为API Key "${apiKey}" 获取新Cookie，请稍候...</div>
                `;
                
                // 调用刷新API
                const response = await fetch(`/v1/refresh-cookies?apiKey=${encodeURIComponent(apiKey)}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP错误: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('keyListMessage').innerHTML = `
                        <div class="info">已开始为API Key "${apiKey}" 获取新Cookie，此过程将在后台运行，可能需要2-12分钟。请稍后刷新页面查看结果。</div>
                    `;
                    
                    // 1分钟后自动刷新API Key列表
                    setTimeout(() => {
                        refreshApiKeyList();
                    }, 60000);
                } else {
                    throw new Error(data.message || '未知错误');
                }
            } catch (error) {
                console.error(`为API Key ${apiKey} 刷新Cookie失败:`, error);
                document.getElementById('keyListMessage').innerHTML = `
                    <div class="error">获取Cookie失败: ${error.message}</div>
                `;
            }
        }

        // 刷新Cookie按钮事件
        document.getElementById('refreshCookieBtn').addEventListener('click', async function() {
            const refreshBtn = this;
            const apiKey = document.getElementById('refreshApiKey').value;
            const statusContainer = document.getElementById('refreshStatusContainer');
            const statusText = document.getElementById('refreshStatus');
            const progressBar = document.getElementById('refreshProgress');
            
            // 禁用按钮，显示状态容器
            refreshBtn.disabled = true;
            statusContainer.style.display = 'block';
            statusText.textContent = '正在发送刷新请求...';
            progressBar.value = 10;
            
            try {
                // 构建请求URL
                let url = '/v1/refresh-cookies';
                if (apiKey) {
                    url += `?apiKey=${encodeURIComponent(apiKey)}`;
                }
                
                // 发送刷新请求
                statusText.textContent = '正在发送刷新请求...';
                progressBar.value = 20;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP错误: ${response.status} ${response.statusText}`);
                }
                
                // 显示长时间等待提示
                statusText.textContent = '刷新请求已发送，请耐心等待2-12分钟...';
                progressBar.value = 50;
                showMessage('refreshCookieMessage', '刷新请求已发送，由于需要访问Cursor官网获取新Cookie，整个过程可能需要2-12分钟，请耐心等待。您可以关闭此页面，稍后再来查看结果。', 'info');
                
                // 延迟5秒后恢复按钮状态
                setTimeout(() => {
                    refreshBtn.disabled = false;
                    statusContainer.style.display = 'none';
                }, 5000);
                
                // 延迟一段时间后重新加载API Key列表
                setTimeout(() => {
                    loadApiKeys();
                    populateRefreshApiKeySelect();
                }, 720000); // 12分钟后刷新列表
                
            } catch (error) {
                console.error('刷新Cookie失败:', error);
                statusText.textContent = '刷新请求发送失败';
                progressBar.value = 0;
                showMessage('refreshCookieMessage', `刷新请求发送失败: ${error.message}`, 'error');
                refreshBtn.disabled = false;
            }
        });

        // 检查登录状态
        function checkAuth() {
            const token = localStorage.getItem('adminToken');
            if (!token) {
                window.location.href = '/login.html';
                return;
            }
            
            // 验证token
            fetch('/v1/admin/verify', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    localStorage.removeItem('adminToken');
                    window.location.href = '/login.html';
                } else {
                    // 显示管理员用户名
                    document.getElementById('adminUsername').textContent = `管理员：${data.username}`;
                }
            })
            .catch(error => {
                console.error('验证失败:', error);
                localStorage.removeItem('adminToken');
                window.location.href = '/login.html';
            });
        }

        // 退出登录
        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.removeItem('adminToken');
            window.location.href = '/login.html';
        });

        // 添加token到所有API请求
        function addAuthHeader(headers = {}) {
            const token = localStorage.getItem('adminToken');
            return {
                ...headers,
                'Authorization': `Bearer ${token}`
            };
        }

        // 修改所有fetch请求，添加token
        const originalFetch = window.fetch;
        window.fetch = function(url, options = {}) {
            // 只对管理页面的API请求添加token
            if (url.includes('/v1/api-keys') || 
                url.includes('/v1/invalid-cookies') || 
                url.includes('/v1/refresh-cookies')) {
                options.headers = addAuthHeader(options.headers);
            }
            return originalFetch(url, options);
        };

        // 加载自动获取配置
        async function loadAutoFetchConfig() {
            try {
                const response = await fetch('/v1/auto-fetch-config', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP错误: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('autoFetchEnabled').checked = data.config.enabled;
                    document.getElementById('autoFetchThreshold').value = data.config.threshold;
                    console.log('已加载自动获取配置:', data.config);
                }
            } catch (error) {
                console.error('加载自动获取配置失败:', error);
                document.getElementById('autoFetchConfigMessage').innerHTML = `
                    <div class="error">加载配置失败: ${error.message}</div>
                `;
            }
        }

        // 提交自动获取配置表单
        document.getElementById('autoFetchConfigForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const enabled = document.getElementById('autoFetchEnabled').checked;
            const threshold = parseInt(document.getElementById('autoFetchThreshold').value);
            
            try {
                const response = await fetch('/v1/auto-fetch-config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        enabled,
                        threshold
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP错误: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('autoFetchConfigMessage').innerHTML = `
                        <div class="info">设置已保存: 已${data.config.enabled ? '启用' : '禁用'}自动获取，阈值设为${data.config.threshold}</div>
                    `;
                    
                    // 更新后刷新API Key列表，以更新警告显示
                    refreshApiKeyList();
                } else {
                    throw new Error(data.message || '未知错误');
                }
            } catch (error) {
                console.error('保存自动获取配置失败:', error);
                document.getElementById('autoFetchConfigMessage').innerHTML = `
                    <div class="error">保存配置失败: ${error.message}</div>
                `;
            }
        });

        // 加载Cookie轮换策略配置
        async function loadRotationStrategy() {
            try {
                const response = await fetch('/v1/rotation-strategy', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP错误: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('rotationStrategy').value = data.strategy;
                    console.log('已加载Cookie轮换策略:', data.strategy);
                }
            } catch (error) {
                console.error('加载Cookie轮换策略失败:', error);
                document.getElementById('rotationStrategyMessage').innerHTML = `
                    <div class="error">加载策略失败: ${error.message}</div>
                `;
            }
        }

        // 提交Cookie轮换策略表单
        document.getElementById('rotationStrategyForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const strategy = document.getElementById('rotationStrategy').value;
            
            try {
                const response = await fetch('/v1/rotation-strategy', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        strategy
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP错误: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('rotationStrategyMessage').innerHTML = `
                        <div class="info">策略已保存: ${getStrategyDisplayName(data.strategy)}</div>
                    `;
                } else {
                    throw new Error(data.message || '未知错误');
                }
            } catch (error) {
                console.error('保存Cookie轮换策略失败:', error);
                document.getElementById('rotationStrategyMessage').innerHTML = `
                    <div class="error">保存策略失败: ${error.message}</div>
                `;
            }
        });

        // 获取策略的显示名称
        function getStrategyDisplayName(strategy) {
            const strategyMap = {
                'round-robin': '轮询策略 (round-robin)',
                'random': '随机策略 (random)',
                'health-first': '健康优先 (health-first)'
            };
            return strategyMap[strategy] || strategy;
        }
    </script>
</body>
</html> 